{"name":"Dependency Management","description":"Dependency Management of the CLI built-in Bundler.","author":{"name":"Chunpeng Huo","url":"https://github.com/huochunpeng"},"links":{"static":"docs/cli/cli-bundler/dependency-management","html":"docs/cli/cli-bundler/dependency-management/index.html","fragment":"docs/cli/cli-bundler/dependency-management/index-fragment.html","self":"docs/cli/cli-bundler/dependency-management/index.json"},"content":"\n\n## Introduction\n\nThis page covers the details of dependency management in latest built-in bundler. The new implementation, auto tracing, brings the user experience of built-in bundler to the level of Webpack, while maintaining unique flexibility thanks for the runtime capability of RequireJS and SystemJS.\n\n## Auto Tracing\n\nCLI's built-in bundler behaves very similar to Webpack plus aurelia-webpack-plugin.\n1. auto traces JavaScript dependencies, supports CommonJS, AMD, UMD, and Native ES Module format.\n2. auto stubs core Node.js modules for running in browser, use exact same stubs that Webpack and Browserify use.\n3. auto traces js/html/css dependencies in Aurelia view templates `<require from=\"...\"></require>`.\n\nIt also provides features above Webpack.\n1. wrapping `\"moduleName\"` with `PLATFORM.moduleName(\"moduleName\")` is not required. The built-in bundler understands all Aurelia's convention without the help of `PLATFORM.moduleName`.\n2. in esnext app, `au run --auto-install` to help you install npm packages. You can keep writing code, CLI will install missing npm packages, bundle them, and refresh you browser, see auto-install at end of this page for more details.\n\n> Warning: Limitation of Stubbing Core Node.js Modules\n> Same as Webpack and Browserify, not all core Node.js functionality can be replicated in browser environment. This trick does not magically bring all npm packages to browser.\n\n### Known problem of auto stubbing core Node.js modules\n\nSometimes you may see missing `process` or `Buffer` variable, as they are Node.js globals.\n\nTo fix the missing global, add these to your main${context.language.fileExtension}.\n\n<code-listing heading=\"main${context.language.fileExtension}\">\n  <source-code lang=\"JavaScript\">\n    import process from 'process';\n    window.process = process;\n    import {Buffer} from 'buffer';\n    window.Buffer = Buffer;\n  </source-code>\n  <source-code lang=\"TypeScript\">\n    import * as process from 'process';\n    window.process = process;\n    import {Buffer} from 'buffer';\n    window.Buffer = Buffer;\n  </source-code>\n</code-listing>\n\nMake sure you don't load those npm packages rely on those globals in main${context.language.fileExtension}. You need to delay them after the globals were ready, typically you can load them in app${context.language.fileExtension} or any other component delayed by Aurelia module loading.\n\nIn this scenario, you'd better not use `aurelia.setRoot(App)`, use `aurelia.setRoot(PLATFORM.moduleName('app'))` or `aurelia.setRoot('app')` or `aurelia.setRoot()` to make sure `app` module is delayed.\n\n## Manual Tracing\n\nThere are two scenarios that auto tracing could not cover.\n\n### 1. modules not explicitly required by your code\n\nFor modules not explicitly required (directly or indirectly), we need to tell the bundler to bundle them in.\n\nLet's look at the default `aurelia_project/aurelia.json` of a new app.\n\n```\n\"bundles\": [\n  {\n    \"name\": \"app-bundle.js\",\n    \"source\": [\n      \"**/*.{js,css,html}\"\n    ]\n  },\n  {\n    \"name\": \"vendor-bundle.js\",\n    \"prepend\": [ /* ... */ ],\n    \"dependencies\": [\n      \"aurelia-bootstrapper\",\n      \"aurelia-loader-default\",\n      \"aurelia-pal-browser\",\n      {\n        \"name\": \"aurelia-testing\",\n        // conditional bundling for only dev environment\n        \"env\": \"dev\"\n      },\n      // text module is slightly different for app with SystemJS\n      \"text\"\n    ]\n  }\n],\n\"loader\": {\n  \"type\": \"require\",\n  \"configTarget\": \"vendor-bundle.js\",\n  /* ... */\n}\n```\n\nNote we hard coded five npm packages in `dependencies` of `vendor-bundle`. They are not directly required by your code, so we need to explicitly ask CLI bundler to bundle them.\n\nIt will be very rare for you to have additional dependencies like them.\n\n### Conditional Dependency\n\n`aurelia-testing` is special, it's required by your source code but behind a condition check.\n\n```\nif (environment.testing) {\n  aurelia.use.plugin('aurelia-testing');\n}\n```\n\nBecause tracing is based on static code analysis, CLI bundler cannot smartly make conditional decision. To avoid bundling unnecessary package for production build, CLI bundler removes those conditional plugin(s) from auto traced dependencies. This kind of conditional plugin need to be configured manually.\n\nIn the above config of `aurelia-testing`, we use `\"env\": \"dev\"` to target only dev environment , if you want to target both dev and stage, use `\"env\": \"dev & stage\"`.\n\n### 2. legacy modules that doesn't support any module format\n\nThere are not many npm packages in this category. If you do encounter one of those stubborn packages, there are two choices: prepend or shim.\n\n## Prepend\n\nThis is the best solution to save your time on stubborn npm packages.\n\nThose stubborn npm packages were not designed to work with any module loader. So why wast your time to try wrapping them into AMD modules? Why not just let them do what they were designed to do (polluting the global name space)?\n\nIn `aurelia_project/aurelia.json` vendor-bundle, there is a `prepend` section.\n\n```\n{\n  \"name\": \"vendor-bundle.js\",\n  \"prepend\": [\n    \"node_modules/bluebird/js/browser/bluebird.core.js\",\n    {\n      \"path\": \"node_modules/aurelia-cli/lib/resources/scripts/configure-bluebird-no-long-stacktraces.js\",\n      \"env\": \"stage & prod\"\n    },\n    {\n      \"path\": \"node_modules/aurelia-cli/lib/resources/scripts/configure-bluebird.js\",\n      \"env\": \"dev\"\n    },\n    \"node_modules/requirejs/require.js\"\n  ],\n  \"dependencies\": [\n    // ...\n  ]\n}\n```\n\nvendor-bundle is the entry bundle file which you load up in `index.html`, the entry bundle is specified by `loader.configTarget` in `aurelia.json`.\n\n```\n\"loader\": {\n  \"type\": \"require\",\n  \"configTarget\": \"vendor-bundle.js\",\n  // ...\n}\n```\n\nCLI bundler writes those prepend files at the beginning of `vendor-bundle.js`, most importantly writes the `require.js` at end of the `prepend` list.\n\n`require.js` brings AMD module loader up in browser.\n* everything before it are executed in browser without AMD module loader.\n* all bundled `\"dependencies\"` (and `\"source\"` if there is) are after `require.js`, they are all executed in an AMD environment prepared by `require.js`.\n\nBecause of the preparation of AMD environment, `prepend` only makes sense in vendor-bundle.\n\n### tempusdominus-bootstrap-4\n\nWe will take a troublesome legacy JavaScript library `tempusdominus-bootstrap-4` to demonstrate both `prepend` and `shim`.\n\n`tempusdominus-bootstrap-4` is a jQuery plugin of date picker. It doesn't support either AMD or CommonJS module loader. It depends on jQuery, moment, font-awesome v4 and Bootstrap v4. First we install all npm packages. Bootstrap v4 also needs additional popper.js.\n\n`npm install tempusdominus-bootstrap-4 jquery bootstrap moment font-awesome popper.js` or `yarn add tempusdominus-bootstrap-4 jquery bootstrap moment font-awesome popper.js`\n\nPrepend them before `require.js` so all of them can create JavaScript global objects. Note you need to list them in right order of dependency.\n\n```\n\"bundles\": [\n  // ...\n  {\n    \"name\": \"vendor-bundle.js\",\n    \"prepend\": [\n      /* ... omit bluebird stuff */\n      \"node_modules/jquery/dist/jquery.min.js\",\n      \"node_modules/moment/min/moment-with-locales.min.js\",\n      // need to use umd build of popper.js\n      \"node_modules/popper.js/dist/umd/popper.min.js\",\n      \"node_modules/bootstrap/dist/js/bootstrap.min.js\",\n      \"node_modules/tempusdominus-bootstrap-4/build/js/tempusdominus-bootstrap-4.min.js\",\n      \"node_modules/requirejs/require.js\"\n    ],\n    \"dependencies\": [ /* ... */ ]\n  }\n],\n\"copyFiles\": {\n  // need font-awesome v4 fonts files\n  \"node_modules/font-awesome/fonts/*\": \"font-awesome/fonts\"\n},\n```\n\nNow `$`, `jQuery` and `moment` are global JavaScript objects to your app. You can use them freely without any import (`import $ from 'jquery'`).\n\nTo calm eslint down on warning of `'$' is not defined`, add following line to top of any file that uses those globals.\n```\n/* global $, jQuery, moment */\n```\n\n> Warning\n> With jquery in prepend, please don't `import $ from 'jquery'` in any code. Otherwise, auto tracing will bring in jquery npm package again, causes duplicated jquery loading (one prepend before `require.js`, one npm package after `require.js`).\n\n> Info\n> There is still a way to allow you to write `import $ from 'jquery'` when using prepend, read [onRequiringModule in CLI Bundler advanced](/docs/cli/cli-bundler/advanced) for more details.\n\nAn example of using `tempusdominus-bootstrap-4`:\n\n<code-listing heading=\"app${context.language.fileExtension}\">\n  <source-code lang=\"JavaScript\">\n    /* global $, moment */\n    export class App {\n      value = moment();\n\n      attached() {\n        // for better reuse, wrap datetimepicker\n        // behind an Aurelia custom element.\n        $('#datetimepicker1').datetimepicker({\n          date: this.value\n        });\n\n        $('#datetimepicker1').on('change.datetimepicker', e => {\n          // sync back to value\n          this.value = e.date;\n        });\n      }\n\n      detached() {\n        $('#datetimepicker1').datetimepicker('destroy');\n      }\n    }\n  </source-code>\n  <source-code lang=\"TypeScript\">\n    /* global $, moment */\n    export class App {\n      value = moment();\n\n      attached() {\n        // for better reuse, wrap datetimepicker\n        // behind an Aurelia custom element.\n        $('#datetimepicker1').datetimepicker({\n          date: this.value\n        });\n\n        $('#datetimepicker1').on('change.datetimepicker', e => {\n          // sync back to value\n          this.value = e.date;\n        });\n      }\n\n      detached() {\n        $('#datetimepicker1').datetimepicker('destroy');\n      }\n    }\n  </source-code>\n</code-listing>\n\n<code-listing heading=\"app.html\">\n  <source-code lang=\"HTML\">\n    <template>\n      <require from=\"font-awesome/css/font-awesome.min.css\"></require>\n      <require from=\"bootstrap/css/bootstrap.min.css\"></require>\n      <require from=\"tempusdominus-bootstrap-4/build/css/tempusdominus-bootstrap-4.min.css\"></require>\n      <div class=\"container\">\n        <div class=\"row\">\n          <div class=\"col-sm-6\">\n            <p>Value: ${value}</p>\n            <div class=\"form-group\">\n              <div class=\"input-group date\" id=\"datetimepicker1\" data-target-input=\"nearest\">\n                <input type=\"text\" class=\"form-control datetimepicker-input\" data-target=\"#datetimepicker1\">\n                <div class=\"input-group-append\" data-target=\"#datetimepicker1\" data-toggle=\"datetimepicker\">\n                  <div class=\"input-group-text\"><i class=\"fa fa-calendar\"></i></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </template>\n  </source-code>\n</code-listing>\n\n### Conditional Prepend\n\nYou can conditionally prepend a JavaScript file per environment, like this one conditionally adds a bluebird config for stage and prod environment.\n\n```\n{\n  \"path\": \"node_modules/aurelia-cli/lib/resources/scripts/configure-bluebird-no-long-stacktraces.js\",\n  \"env\": \"stage & prod\"\n}\n```\n\n## Shim\n\nShim is a technique to wrap a legacy JavaScript library into an AMD module. Here is how you wrap `tempusdominus-bootstrap-4` into AMD module, add following to `aurelia_project/aurelia.json` vendor-bundle dependencies:\n\n```\n// remember to remove those jquery/moment... from your prepend\n\"dependencies\": [\n  // ...\n  {\n    \"name\": \"tempusdominus-bootstrap-4\",\n    \"deps\": [\n      \"jquery\",\n      \"bootstrap\",\n      \"popper.js\",\n      \"moment\"\n    ],\n    \"wrapShim\": true\n  }\n]\n```\n\n> Info\n> We only need explicit config for `tempusdominus-bootstrap-4`, all other jquery, bootstrap, popper.js, and moment are handled by auto tracing.\n\nThe above dependency configuration is called \"shim\", a config using `deps` or `exports` or both.\n\n* `deps` - This is an array of dependencies which must be loaded and available before the legacy library can be evaluated.\n* `exports` - (optional) This is the name of the global variable that should be used as the exported value of the module. You don't need to set `exports` if you only do `import \"tempusdominus-bootstrap-4\";` without using any exported object.\n* `wrapShim` - (optional, try this if normal shim does not work) wrap the legacy code in a function. This will delay the execution of the legacy code to module loading time.\n\n> Info: wrapShim\n> CLI also supports global wrapShim setting in `aurelia.json` `loader.config.wrapShim` which forces `wrapShim` on all shim dependencies. More details in [CLI Bundler advanced chapter](/docs/cli/cli-bundler/advanced).\n\n> Info: For Long Time CLI Bundler Users\n> Unlike old version of CLI Bundler, we don't need `path` and `main`. Auto-trace takes care of that. `path` and `main` are now only for flexible use cases such as npm package alias or packages not in node_modules folder. Check [CLI Bundler Advanced chapter](/docs/cli/cli-bundler/advanced) for more details.\n\nUnfortunately, the above config is still not enough for `tempusdominus-bootstrap-4`. `tempusdominus-bootstrap-4` expects a global `moment` object. But as of `momentjs` version 2.10.0, `momentjs` no longer exports global object in AMD module environment. We need to manually expose `moment` object to global namespace before loading up `tempusdominus-bootstrap-4`.\n\n> Info\n> For anyone without much experience of AMD shim, this is quite hard to figure out. That's why we **recommend prepend over shim for any legacy JavaScript library**.\n\nWe can expose `moment` to global namespace in `main.js`, then loads `tempusdominus-bootstrap-4` in `app.js`. Here is a full setup.\n\n```\n// aurelia_project/aurelia.json\n\"bundles\": [\n  // ...\n  {\n    \"name\": \"vendor-bundle.js\",\n    \"prepend\": [ /* ... */ ],\n    \"dependencies\": [\n      // ...\n      {\n        \"name\": \"tempusdominus-bootstrap-4\",\n        \"deps\": [\n          \"jquery\",\n          \"bootstrap\",\n          \"popper.js\",\n          \"moment\"\n        ],\n        \"wrapShim\": true\n      }\n    ]\n  }\n],\n\"copyFiles\": {\n  \"node_modules/font-awesome/fonts/*\": \"font-awesome/fonts\"\n}\n```\n<code-listing heading=\"main${context.language.fileExtension}\">\n  <source-code lang=\"JavaScript\">\n    import moment from 'moment';\n    window.moment = moment;\n  </source-code>\n  <source-code lang=\"TypeScript\">\n    import * as moment from 'moment';\n    window.moment = moment;\n  </source-code>\n</code-listing>\n\n<code-listing heading=\"app${context.language.fileExtension}\">\n  <source-code lang=\"JavaScript\">\n    import $ from 'jquery';\n    import moment from 'moment';\n    import 'tempusdominus-bootstrap-4';\n    export class App {\n      value = moment();\n\n      attached() {\n        // for better reuse, wrap datetimepicker\n        // behind an Aurelia custom element.\n        $('#datetimepicker1').datetimepicker({\n          date: this.value\n        });\n\n        $('#datetimepicker1').on('change.datetimepicker', e => {\n          // sync back to value\n          this.value = e.date;\n        });\n      }\n\n      detached() {\n        $('#datetimepicker1').datetimepicker('destroy');\n      }\n    }\n  </source-code>\n  <source-code lang=\"TypeScript\">\n    import * as $ from 'jquery';\n    import * as moment from 'moment';\n    import 'tempusdominus-bootstrap-4';\n    export class App {\n      value = moment();\n\n      attached() {\n        // for better reuse, wrap datetimepicker\n        // behind an Aurelia custom element.\n        $('#datetimepicker1').datetimepicker({\n          date: this.value\n        });\n\n        $('#datetimepicker1').on('change.datetimepicker', e => {\n          // sync back to value\n          this.value = e.date;\n        });\n      }\n\n      detached() {\n        $('#datetimepicker1').datetimepicker('destroy');\n      }\n    }\n  </source-code>\n</code-listing>\n\n<code-listing heading=\"app.html\">\n  <source-code lang=\"HTML\">\n    <template>\n      <require from=\"font-awesome/css/font-awesome.min.css\"></require>\n      <require from=\"bootstrap/css/bootstrap.min.css\"></require>\n      <require from=\"tempusdominus-bootstrap-4/build/css/tempusdominus-bootstrap-4.min.css\"></require>\n      <div class=\"container\">\n        <div class=\"row\">\n          <div class=\"col-sm-6\">\n            <p>Value: ${value}</p>\n            <div class=\"form-group\">\n              <div class=\"input-group date\" id=\"datetimepicker1\" data-target-input=\"nearest\">\n                <input type=\"text\" class=\"form-control datetimepicker-input\" data-target=\"#datetimepicker1\">\n                <div class=\"input-group-append\" data-target=\"#datetimepicker1\" data-toggle=\"datetimepicker\">\n                  <div class=\"input-group-text\"><i class=\"fa fa-calendar\"></i></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </template>\n  </source-code>\n</code-listing>\n\n## au run --auto-install\n\nWhen you run `au run` with `--auto-install`, it auto installs missing npm packages while tracing your source code. You can keep writing code, CLI bundler will take care of `npm install some-package` (or `yarn add some-package`).\n\n> Warning: TypeScript App is Not Supported\n> Due to TypeScript stops compilation when detecting missing npm package, CLI bundler could not get any information on the missing package.\n\nThis is lots of fun! You could just write `<require from=\"bootstrap/css/bootstrap.min.css\"></require>` in `app.html`, then shortly after, boom! you will see style change in browser.\n\n> Info: Limitation\n> auto-install only installs latest version of the package, if you want a special version, do manual install.\n\n"}